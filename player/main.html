<!DOCTYPE html>
<html>
<head>
  <title>Main Active Desktop Page</title>
  <style>
    :root {
      --gap-desktop: 10px;
      --gap-mobile: 6px;
      --iframe-mobile-height: 220px;
    }
    body { margin: 0; font-family: system-ui, sans-serif; background: #111; color: #eee; }
    .controls {
      position: sticky;
      top: 0;
      background: #1a1a1a;
      border-bottom: 1px solid #333;
      padding: 12px;
      z-index: 10;
      text-align: center;
    }
    .controls h1 { margin: 0 0 8px; font-size: 20px; }
    .controls .row { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
    button {
      border: 1px solid #444;
      background: #222;
      color: #eee;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      transition: background .15s ease, border-color .15s ease;
    }
    button:hover { background: #2b2b2b; border-color: #666; }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr); /* desktop: 4 columns */
      gap: var(--gap-desktop);
      padding: var(--gap-desktop);
      height: 80vh;
    }
    iframe { width: 100%; height: 100%; border: none; border-radius: 8px; background: #000; }

    /* Mobile responsive */
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: repeat(2, 1fr); /* mobile: 2 columns */
        gap: var(--gap-mobile);
        height: auto;
      }
      iframe { height: var(--iframe-mobile-height); }
    }

    /* Small hint footer */
    .hint { text-align: center; font-size: 12px; color: #aaa; padding-bottom: 10px; }
  </style>
</head>
<body>
  <div class="controls">
    <h1>Main Active Desktop Page</h1>
    <div class="row">
      <button onclick="playAll()">‚ñ∂ Play All</button>
      <button onclick="pauseAll()">‚è∏ Pause All</button>
      <button onclick="nextAll()">‚è≠ Next All</button>
      <button onclick="shuffleAll()">üé≤ Shuffle All</button>
      <button onclick="restartAll()">üîÅ Restart All</button>
      <button onclick="stopAll()">‚èπ Stop All</button>
      <button onclick="toggleMuteAll()">üîá Mute/Unmute All</button>
      <button onclick="randomizeVolumeAll()">üîä Volume Randomize All</button>
      <button onclick="normalizeVolumeAll()">üéö Volume Normalize All</button>
    </div>
    <div class="hint">Auto‚Äënext, mid‚Äëseek, random pauses, periodic volume changes, and extended start delays are enabled.</div>
  </div>

  <div class="grid">
    <div id="player1"></div>
    <div id="player2"></div>
    <div id="player3"></div>
    <div id="player4"></div>
    <div id="player5"></div>
    <div id="player6"></div>
    <div id="player7"></div>
    <div id="player8"></div>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    // --- State ---
    let players = [];
    let videoList = [];
    let isMutedAll = true;

    // --- Settings (tuned for "natural" behavior) ---
    const MIN_START_DELAY_S = 5;     // start delays: 5‚Äì180s, more asynchronous
    const MAX_START_DELAY_S = 180;
    const MIN_PLAY_MIN = 10;         // base play time window
    const MAX_PLAY_MIN = 15;
    const EXTRA_JITTER_S = [20, 60]; // extra jitter before next video
    const INIT_SEEK_S_MAX = 75;      // initial seek window (0‚Äì75s)
    const MID_SEEK_INTERVAL_MIN = [5, 9]; // every 5‚Äì9 minutes, mid‚Äëvideo seek to simulate skipping
    const MID_SEEK_WINDOW_S = [45, 180];  // seek window within the video
    const PAUSE_SMALL_S = [2, 5];    // small micro‚Äëpauses 2‚Äì5s
    const PAUSE_LARGE_S = [18, 35];  // larger pauses 18‚Äì35s
    const PAUSE_WITHIN_MIN = 6;      // schedule pauses within first N minutes of a session
    const INIT_VOLUME_RANGE = [0, 20];     // start volume range to be autoplay‚Äëfriendly
    const PERIODIC_VOL_INTERVAL_MIN = [3, 7]; // every 3‚Äì7 minutes tweak volume slightly
    const PERIODIC_VOL_STEP = [-8, 12];   // small adjustments per step
    const NORMALIZE_VOLUME_TARGET = 20;   // normalize to 20%

    // --- Utils ---
    const ts = () => new Date().toLocaleTimeString();
    const rndInt = (min, max) => Math.floor(min + Math.random() * (max - min + 1));
    const rndFloatMs = (minS, maxS) => (minS + Math.random() * (maxS - minS)) * 1000;
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

    // --- Load remote list ---
    fetch("https://raw.githubusercontent.com/DeadManWalkingTO/MacrosDmW/refs/heads/main/player/list.txt")
      .then(r => r.text())
      .then(text => {
        videoList = text.trim().split("\n").filter(Boolean);
        initPlayers(getRandomVideos(8));
      });

    function getRandomVideos(n) {
      const shuffled = [...videoList].sort(() => Math.random() - 0.5);
      return shuffled.slice(0, n);
    }

    function initPlayers(videoIds) {
      videoIds.forEach((id, index) => {
        players[index] = new YT.Player(`player${index+1}`, {
          videoId: id,
          events: {
            onReady: onPlayerReady,
            onStateChange: onPlayerStateChange
          }
        });
      });
    }

    // --- Player lifecycle ---
    function onPlayerReady(event) {
      const p = event.target;
      p.mute();

      const startDelayMs = rndFloatMs(MIN_START_DELAY_S, MAX_START_DELAY_S);
      setTimeout(() => {
        const seek = rndInt(0, INIT_SEEK_S_MAX);
        const initVol = rndInt(INIT_VOLUME_RANGE[0], INIT_VOLUME_RANGE[1]);

        p.seekTo(seek, true);
        p.setVolume(initVol);
        p.playVideo();
        p.setPlaybackQuality('small');

        console.log(`[${ts()}] ‚ñ∂ Start: id=${p.getVideoData().video_id}, seek=${seek}s, vol=${initVol}%`);
        scheduleNext(p);
        scheduleRandomPauses(p);
        scheduleMidVideoSeek(p);
        schedulePeriodicVolume(p);
      }, startDelayMs);
    }

    function scheduleNext(player) {
      const baseMs = (MIN_PLAY_MIN + Math.random() * (MAX_PLAY_MIN - MIN_PLAY_MIN)) * 60000;
      const jitterMs = rndFloatMs(EXTRA_JITTER_S[0], EXTRA_JITTER_S[1]);

      setTimeout(() => {
        const newId = getRandomVideos(1)[0];
        const seek = rndInt(0, INIT_SEEK_S_MAX);
        const vol = rndInt(INIT_VOLUME_RANGE[0], INIT_VOLUME_RANGE[1]);

        player.loadVideoById(newId);
        player.seekTo(seek, true);
        player.setVolume(vol);
        player.mute(); // keep autoplay consistent
        player.playVideo();
        player.setPlaybackQuality('small');

        console.log(`[${ts()}] üîÑ Next timed: id=${newId}, seek=${seek}s, vol=${vol}%, wait=${Math.round((baseMs+jitterMs)/1000)}s`);
        // Re‚Äëschedule behaviors for the new session
        scheduleNext(player);
        scheduleRandomPauses(player);
        scheduleMidVideoSeek(player);
        schedulePeriodicVolume(player);
      }, baseMs + jitterMs);
    }

    function onPlayerStateChange(event) {
      const p = event.target;
      if (event.data === YT.PlayerState.ENDED) {
        const newId = getRandomVideos(1)[0];
        const seek = rndInt(MID_SEEK_WINDOW_S[0], MID_SEEK_WINDOW_S[1]);
        p.loadVideoById(newId);
        p.seekTo(seek, true);
        p.setPlaybackQuality('small');
        console.log(`[${ts()}] ‚è≠ Auto‚Äënext: id=${newId}, seek=${seek}s`);
        // Re‚Äëenable behaviors after auto‚Äënext
        scheduleNext(p);
        scheduleRandomPauses(p);
        scheduleMidVideoSeek(p);
        schedulePeriodicVolume(p);
      }
    }

    // --- Natural behaviors ---
    function scheduleRandomPauses(player) {
      const withinMs = PAUSE_WITHIN_MIN * 60000;
      // Decide whether to do small or large pause first
      const doSmallFirst = Math.random() < 0.6;

      const schedulePause = (rangeS, label) => {
        const delayMs = Math.random() * withinMs; // when to pause
        const pauseLenMs = rndFloatMs(rangeS[0], rangeS[1]);
        setTimeout(() => {
          player.pauseVideo();
          console.log(`[${ts()}] ‚è∏ Pause (${label} ${Math.round(pauseLenMs/1000)}s): id=${player.getVideoData().video_id}`);
          setTimeout(() => {
            player.playVideo();
            console.log(`[${ts()}] ‚ñ∂ Resume: id=${player.getVideoData().video_id}`);
          }, pauseLenMs);
        }, delayMs);
      };

      if (doSmallFirst) {
        schedulePause(PAUSE_SMALL_S, 'small');
        schedulePause(PAUSE_LARGE_S, 'large');
      } else {
        schedulePause(PAUSE_LARGE_S, 'large');
        schedulePause(PAUSE_SMALL_S, 'small');
      }
    }

    function scheduleMidVideoSeek(player) {
      const intervalMin = rndInt(MID_SEEK_INTERVAL_MIN[0], MID_SEEK_INTERVAL_MIN[1]);
      const delayMs = intervalMin * 60000;
      setTimeout(() => {
        const seek = rndInt(MID_SEEK_WINDOW_S[0], MID_SEEK_WINDOW_S[1]);
        player.seekTo(seek, true);
        console.log(`[${ts()}] ‚§¥ Mid‚Äëseek: id=${player.getVideoData().video_id}, to=${seek}s`);
        // Chain another mid‚Äëseek for continued natural behavior
        scheduleMidVideoSeek(player);
      }, delayMs);
    }

    function schedulePeriodicVolume(player) {
      const intervalMin = rndInt(PERIODIC_VOL_INTERVAL_MIN[0], PERIODIC_VOL_INTERVAL_MIN[1]);
      const delayMs = intervalMin * 60000;
      setTimeout(() => {
        const currentVol = player.getVolume?.() ?? NORMALIZE_VOLUME_TARGET;
        const step = rndInt(PERIODIC_VOL_STEP[0], PERIODIC_VOL_STEP[1]);
        const newVol = clamp(currentVol + step, 0, 100);
        player.setVolume(newVol);
        console.log(`[${ts()}] üéö Periodic volume: id=${player.getVideoData().video_id}, ${currentVol}% -> ${newVol}%`);
        // Continue periodic adjustments
        schedulePeriodicVolume(player);
      }, delayMs);
    }

    // --- Controls ---
    function playAll() { players.forEach(p => p.playVideo()); console.log(`[${ts()}] ‚ñ∂ Play All`); }
    function pauseAll() { players.forEach(p => p.pauseVideo()); console.log(`[${ts()}] ‚è∏ Pause All`); }
    function stopAll() { players.forEach(p => p.stopVideo()); console.log(`[${ts()}] ‚èπ Stop All`); }

    function nextAll() {
      players.forEach(p => {
        const newId = getRandomVideos(1)[0];
        p.loadVideoById(newId);
        p.playVideo();
        console.log(`[${ts()}] ‚è≠ Manual next: id=${newId}`);
      });
    }

    function shuffleAll() {
      const shuffled = getRandomVideos(players.length);
      players.forEach((p, i) => {
        p.loadVideoById(shuffled[i]);
        p.playVideo();
        console.log(`[${ts()}] üé≤ Shuffle: p${i+1} -> ${shuffled[i]}`);
      });
    }

    function restartAll() {
      const newSet = getRandomVideos(players.length);
      players.forEach((p, i) => {
        p.stopVideo();
        p.loadVideoById(newSet[i]);
        p.playVideo();
        console.log(`[${ts()}] üîÅ Restart: p${i+1} -> ${newSet[i]}`);
      });
    }

    function toggleMuteAll() {
      if (isMutedAll) {
        players.forEach(p => p.unMute());
        console.log(`[${ts()}] üîä Unmute All`);
      } else {
        players.forEach(p => p.mute());
        console.log(`[${ts()}] üîá Mute All`);
      }
      isMutedAll = !isMutedAll;
    }

    function randomizeVolumeAll() {
      players.forEach((p, i) => {
        const v = rndInt(0, 100);
        p.setVolume(v);
        console.log(`[${ts()}] üîä Random volume: p${i+1} -> ${v}%`);
      });
    }

    function normalizeVolumeAll() {
      players.forEach((p, i) => {
        p.setVolume(NORMALIZE_VOLUME_TARGET);
        console.log(`[${ts()}] üéö Normalize volume: p${i+1} -> ${NORMALIZE_VOLUME_TARGET}%`);
      });
    }
  </script>
</body>
</html>
